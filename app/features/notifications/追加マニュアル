"""
==============================
ğŸ“Œ ã€é€šçŸ¥å‡¦ç†ã®è¿½åŠ æ–¹æ³•ã€‘(ãƒãƒ‹ãƒ¥ã‚¢ãƒ«)
==============================

ã“ã® `dispatcher.py` ã¯ã€é€šçŸ¥å‡¦ç†ã‚’ä¸€å…ƒç®¡ç†ã—ã€é©åˆ‡ãªé€šçŸ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (`handlers/` ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«) ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹å½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚
æ–°ã—ã„é€šçŸ¥å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦ãã ã•ã„ã€‚

ğŸ”¹ **1. `handlers/` ã«é€šçŸ¥å‡¦ç†ç”¨ã®æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ**
   - `app/features/notifications/handlers/` é…ä¸‹ã« `reservation_updated.py` ãªã©ã®æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
   - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `reservation_xxx.py` ã®ã‚ˆã†ã«ã€`send_xxx` å½¢å¼ã®é–¢æ•°åã¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã€‚

ğŸ”¹ **2. `send_` ã‹ã‚‰å§‹ã¾ã‚‹é–¢æ•°ã‚’å®šç¾©**
   - ä¾‹ãˆã°ã€`reservation_updated.py` ãªã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆã™ã‚‹ï¼š

   ```python
   from sqlalchemy.orm import Session
   from app.features.notifications.templates import get_template
   from app.features.notifications.variables import get_reservation_variables
   from app.features.notifications.line import send_line_message
   from app.features.notifications.repository.getlineID_repository import get_user_line_id  

   def send_reservation_updated(db: Session, reservation_id: int, user_id: int):
       """
       äºˆç´„æ›´æ–°æ™‚ã®é€šçŸ¥ã‚’é€ã‚‹
       """
       # 1ï¸âƒ£ äºˆç´„æƒ…å ±ã‚’å–å¾—
       variables = get_reservation_variables(db, reservation_id)

       # 2ï¸âƒ£ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
       template = get_template("reservation_updated")
       message = template.format(**variables)

       # 3ï¸âƒ£ LINE ID ã‚’å–å¾—ã—ã€é€ä¿¡
       line_id = get_user_line_id(db, user_id)
       if line_id:
           send_line_message(line_id, message)
       else:
           print(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ {user_id} ã®LINE IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
ğŸ”¹ 3. dispatcher.send("reservation_updated", db=db, reservation_id=1001, user_id=41) ã§å‘¼ã³å‡ºã—

reservation_updated ã¨ã„ã†ã‚­ãƒ¼ã§è‡ªå‹•çš„ã« send_reservation_updated() ãŒå‘¼ã°ã‚Œã‚‹ã€‚
ğŸ”¹ 4. TEMPLATES ã«æ–‡è¨€ã‚’è¿½åŠ 

app/features/notifications/templates.py ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ï¼š
python
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
TEMPLATES = {
    "reservation_updated": "äºˆç´„ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚\n\nğŸ“ å ´æ‰€: {location}\nğŸ“… æ–°ã—ã„æ—¥æ™‚: {date} {time}"
}
ã“ã‚Œã§ã€æ–°ã—ã„é€šçŸ¥å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹æº–å‚™ãŒå®Œäº†ã—ã¾ã™ï¼ ğŸš€ """

âœ… handlers/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
NOTIFICATION_HANDLERS = {}

for , module_name, _ in pkgutil.iter_modules(handlers.path): module = importlib.import_module(f"app.features.notifications.handlers.{module_name}") handler_func = getattr(module, f"send{module_name}", None) if handler_func: NOTIFICATION_HANDLERS[module_name] = handler_func

def send(notification_type, **kwargs): """ é€šçŸ¥ã‚’é©åˆ‡ãªå‡¦ç†ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚‚è‡ªå‹•åŒ–ï¼‰ """ handler = NOTIFICATION_HANDLERS.get(notification_type) if handler: handler(**kwargs) else: print(f"âŒ æœªçŸ¥ã®é€šçŸ¥ã‚¿ã‚¤ãƒ—: {notification_type}")

yaml
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹

---

### âœ… **ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®ãƒã‚¤ãƒ³ãƒˆ**
1ï¸âƒ£ **ã©ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã‹ (`handlers/` ã«æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹) ã‚’æ˜è¨˜ï¼**  
2ï¸âƒ£ **é–¢æ•°ã®å‘½åãƒ«ãƒ¼ãƒ« (`send_xxx`) ã‚’çµ±ä¸€ã—ã€é–“é•ã„ãŒèµ·ããªã„ã‚ˆã†ã«ï¼**  
3ï¸âƒ£ **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (`TEMPLATES`) ã®è¿½åŠ ã‚‚èª¬æ˜ï¼**  
4ï¸âƒ£ **å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å…¥ã‚Œã¦ã€å®Ÿéš›ã®è¿½åŠ ä½œæ¥­ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ï¼**  

ğŸš€ **ã“ã‚Œã§ã€Œé€šçŸ¥ã®è¿½åŠ æ‰‹é †ã€ãŒã™ãåˆ†ã‹ã‚‹ï¼ã“ã®ã¾ã¾é€²ã‚ã‚ˆã†ï¼** ğŸ¯






